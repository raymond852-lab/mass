// é¡Œåº«è¨­è¨ˆï¼šLevel 1 (æ•´æ•¸/ä¸€åŠ) å’Œ Level 2 (25g å››åˆ†æ ¼)
const questions = [
    // --- Level 1: åŸºç¤æ›ç®—èˆ‡ 50g ---
    {
        type: "convert",
        text: "1 kg ç­‰æ–¼å¤šå°‘ gï¼Ÿ",
        answer: "1000g",
        options: ["100g", "1000g", "10g", "500g"],
        hint: "å£è¨£ï¼šåŠ  3 å€‹ 0 è®Šå¤§èƒ–å­ï¼"
    },
    {
        type: "scale",
        text: "æŒ‡é‡æŒ‡åœ¨å“ªè£¡ï¼Ÿ(æ³¨æ„é€™æ˜¯ä¸€åŠ)",
        val: 150, max: 200, step: 50, // 0-100 åˆ†å…©æ ¼
        answer: "150g",
        options: ["100g", "150g", "125g", "200g"],
        hint: "0 åˆ° 100 çš„ä¸­é–“æ˜¯ 50 å–”ï¼"
    },
    {
        type: "scale",
        text: "æŒ‡é‡éäº† 200ï¼Œåœ¨ä¸­é–“ï¼",
        val: 250, max: 400, step: 50,
        answer: "250g",
        options: ["200g", "250g", "300g", "205g"],
        hint: "éäº† 200ï¼Œåˆå¤šäº†ä¸€åŠ (50)ï¼"
    },
    {
        type: "convert",
        text: "3 kg 500 g ç­‰æ–¼å¤šå°‘ gï¼Ÿ",
        answer: "3500g",
        options: ["3050g", "3500g", "350g", "5300g"],
        hint: "3kg å°±æ˜¯ 3000gï¼ŒåŠ ä¸Š 500g å‘¢ï¼Ÿ"
    },
    
    // --- Level 3: 25g çš„æŒ‘æˆ° (100g åˆ† 4 æ ¼) ---
    // é€™è£¡æˆ‘å€‘è¨­å®š step: 25ï¼Œç¨‹å¼æœƒè‡ªå‹•ç•«å‡ºç´°åˆ†åˆ»åº¦
    {
        type: "scale",
        text: "é­”ç‹é¡Œï¼šæŒ‡é‡æŒ‡åœ¨ç¬¬ä¸€å°æ ¼ï¼",
        val: 25, max: 100, step: 25, 
        answer: "25g",
        options: ["10g", "20g", "25g", "50g"],
        hint: "100g åˆ†æˆ 4 ä»½ï¼Œä¸€æ ¼æ˜¯ 25gï¼"
    },
    {
        type: "scale",
        text: "ä»”ç´°çœ‹ï¼Œé€™æ˜¯å¤šå°‘ï¼Ÿ",
        val: 75, max: 100, step: 25,
        answer: "75g",
        options: ["50g", "75g", "80g", "60g"],
        hint: "25, 50, 75... æ•¸æ•¸çœ‹ï¼"
    },
    {
        type: "scale",
        text: "æŒ‡é‡éäº† 100ï¼Œåœ¨ç¬¬ä¸€å°æ ¼",
        val: 125, max: 200, step: 25,
        answer: "125g",
        options: ["110g", "125g", "150g", "105g"],
        hint: "100 + 25 = ?"
    },
    {
        type: "scale",
        text: "é€™åŒ…ç³–æœæœ‰å¤šé‡ï¼Ÿ",
        val: 175, max: 200, step: 25,
        answer: "175g",
        options: ["150g", "175g", "180g", "125g"],
        hint: "é‚„å·®ä¸€æ ¼å°±åˆ° 200 äº† (200 - 25)"
    },
    {
        type: "scale",
        text: "æŒ‡é‡éäº† 200ï¼Œåˆéäº†å…©æ ¼",
        val: 250, max: 300, step: 25,
        answer: "250g",
        options: ["225g", "250g", "275g", "205g"],
        hint: "200 + 25 + 25 = ?"
    },
    {
        type: "convert",
        text: "æœ€å¾Œä¸€é¡Œï¼šåŠå…¬æ–¤ (0.5kg) æ˜¯å¤šå°‘ï¼Ÿ",
        answer: "500g",
        options: ["50g", "500g", "5000g", "5g"],
        hint: "1å…¬æ–¤æ˜¯1000gï¼Œä¸€åŠå°±æ˜¯..."
    }
];

let currentQIndex = 0;
let score = 0;

function startGame() {
    document.getElementById('start-screen').classList.remove('active');
    document.getElementById('game-screen').classList.add('active');
    loadQuestion();
}

function loadQuestion() {
    if (currentQIndex >= questions.length) {
        showResult();
        return;
    }

    const q = questions[currentQIndex];
    document.getElementById('current-q').innerText = currentQIndex + 1;
    document.getElementById('question-text').innerText = q.text;
    
    // é‡ç½®æç¤ºèˆ‡å›é¥‹
    const feedback = document.getElementById('feedback');
    feedback.className = 'feedback hidden';
    feedback.innerText = "";

    // ç¹ªåœ–å€åŸŸè™•ç†
    const visualArea = document.getElementById('canvas-container');
    visualArea.innerHTML = ''; // æ¸…ç©ºèˆŠåœ–
    
    if (q.type === 'scale') {
        // è‡ªå‹•ç•«å‡º SVG ç§¤ (å‚³å…¥æ•¸å€¼ã€æœ€å¤§å€¼ã€åˆ»åº¦é–“è·)
        visualArea.appendChild(drawScale(q.val, q.max, q.step));
    } else {
        // æ›ç®—é¡Œé¡¯ç¤ºå¤§ Emoji
        visualArea.innerHTML = '<div style="font-size: 80px; margin: 20px;">âš–ï¸ğŸ¬</div>';
    }

    // ç”¢ç”Ÿé¸é …æŒ‰éˆ•
    const optionsDiv = document.getElementById('options-container');
    optionsDiv.innerHTML = '';
    
    // æŠŠé¸é …æ‰“äº‚é †åº
    const shuffledOptions = [...q.options].sort(() => Math.random() - 0.5);

    shuffledOptions.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'option-btn';
        btn.innerText = opt;
        btn.onclick = () => checkAnswer(opt, q.answer, q.hint);
        optionsDiv.appendChild(btn);
    });
}

function checkAnswer(selected, correct, hintText) {
    const feedback = document.getElementById('feedback');
    feedback.classList.remove('hidden');

    if (selected === correct) {
        score += 10;
        document.getElementById('score').innerText = score;
        feedback.innerText = "ğŸ‰ ç­”å°äº†ï¼å¤ªæ£’äº†ï¼";
        feedback.className = "feedback correct";
        
        // ç­”å°å¾Œå»¶é² 1 ç§’é€²å…¥ä¸‹ä¸€é¡Œ
        setTimeout(() => {
            currentQIndex++;
            loadQuestion();
        }, 1500);
    } else {
        feedback.innerText = "âŒ å“å‘€ï¼Œå†è©¦è©¦çœ‹ï¼\nğŸ’¡ æç¤ºï¼š" + hintText;
        feedback.className = "feedback wrong";
    }
}

function showResult() {
    document.getElementById('game-screen').classList.remove('active');
    document.getElementById('result-screen').classList.add('active');
    document.getElementById('final-score').innerText = score;
    
    let comment = "";
    if (score === 100) comment = "ğŸ‘‘ å®Œç¾ï¼ä½ æ˜¯çœŸæ­£çš„é‡é‡å¤§å¸«ï¼";
    else if (score >= 80) comment = "ğŸŒŸ å¾ˆæ£’å–”ï¼åªå·®ä¸€é»é»ï¼";
    else comment = "ğŸ’ª åŠ æ²¹ï¼å¤šç·´ç¿’å¹¾æ¬¡å°±æœƒäº†ï¼";
    
    document.getElementById('comment').innerText = comment;
}

// ğŸ¨ SVG ç•«ç§¤å¼•æ“ (é€™è£¡æœƒç”¢ç”Ÿä½ æƒ³è¦çš„åœ–ç‰‡)
function drawScale(value, maxVal, step) {
    const svgNS = "http://www.w3.org/2000/svg";
    const svg = document.createElementNS(svgNS, "svg");
    svg.setAttribute("viewBox", "0 0 200 160"); // ç•«å¸ƒå¤§å°
    
    // å®šç¾©ä¸­å¿ƒé»å’ŒåŠå¾‘
    const cx = 100;
    const cy = 130;
    const r = 100;

    // 1. ç•«ç§¤çš„å¤–æ¡† (åŠåœ“å½¢)
    const arc = document.createElementNS(svgNS, "path");
    // M=ç§»å‹•åˆ°å·¦ä¸‹, A=ç•«åœ“å¼§åˆ°å³ä¸‹, L=å›åˆ°åœ“å¿ƒ, Z=é–‰åˆ
    // é€™è£¡ç•«ä¸€å€‹å¾å·¦(-90åº¦)åˆ°å³(90åº¦)çš„åŠåœ“ç›¤
    arc.setAttribute("d", "M 10 130 A 90 90 0 0 1 190 130");
    arc.setAttribute("fill", "none");
    arc.setAttribute("stroke", "#4D96FF");
    arc.setAttribute("stroke-width", "4");
    arc.setAttribute("stroke-linecap", "round");
    svg.appendChild(arc);

    // 2. ç•«åˆ»åº¦ (Tick Marks)
    // æˆ‘å€‘åªé¡¯ç¤ºéƒ¨åˆ†åˆ»åº¦ï¼Œé¿å…å¤ªæ“æ“ 
    // ç¸½è§’åº¦æ˜¯ 180 åº¦ã€‚
    // å‡è¨­ maxVal æ˜¯ç¸½ç¯„åœã€‚
    
    for (let i = 0; i <= maxVal; i += step) {
        // è¨ˆç®—è§’åº¦ï¼šå°‡æ•¸å€¼æ˜ å°„åˆ° 0~180åº¦
        // å·¦é‚Š(0)æ˜¯ -90åº¦(ä¹Ÿå°±æ˜¯270åº¦æ–¹å‘)ï¼Œå³é‚Š(max)æ˜¯ 90åº¦
        const percent = i / maxVal;
        const angleDeg = -90 + (percent * 180);
        const angleRad = (angleDeg * Math.PI) / 180;

        // åˆ¤æ–·æ˜¯å¤§æ ¼(100çš„å€æ•¸) é‚„æ˜¯å°æ ¼
        const isMajor = (i % 100 === 0);
        
        // ç·šæ¢é•·åº¦
        const tickLen = isMajor ? 15 : 8;
        const strokeW = isMajor ? 2 : 1;
        const color = isMajor ? "#FF6B6B" : "#555"; // å¤§æ ¼ç´…è‰²ï¼Œå°æ ¼ç°è‰²

        // è¨ˆç®—ç·šæ¢èµ·é»(å¤–åœˆ)å’Œçµ‚é»(å¾€åœ“å¿ƒç¸®)
        const x1 = cx + (r - 10) * Math.cos(angleRad);
        const y1 = cy + (r - 10) * Math.sin(angleRad);
        const x2 = cx + (r - 10 - tickLen) * Math.cos(angleRad);
        const y2 = cy + (r - 10 - tickLen) * Math.sin(angleRad);

        const line = document.createElementNS(svgNS, "line");
        line.setAttribute("x1", x1);
        line.setAttribute("y1", y1);
        line.setAttribute("x2", x2);
        line.setAttribute("y2", y2);
        line.setAttribute("stroke", color);
        line.setAttribute("stroke-width", strokeW);
        svg.appendChild(line);

        // å¦‚æœæ˜¯å¤§æ ¼ï¼ŒåŠ ä¸Šæ•¸å­—
        if (isMajor) {
            const tx = cx + (r - 35) * Math.cos(angleRad);
            const ty = cy + (r - 35) * Math.sin(angleRad);
            
            const text = document.createElementNS(svgNS, "text");
            text.setAttribute("x", tx);
            text.setAttribute("y", ty);
            text.setAttribute("text-anchor", "middle");
            text.setAttribute("dominant-baseline", "middle");
            text.setAttribute("fill", "#333");
            text.setAttribute("font-size", "14");
            text.setAttribute("font-weight", "bold");
            text.textContent = i;
            svg.appendChild(text);
        }
    }

    // 3. ç•«æŒ‡é‡ (Needle)
    // ç®—å‡ºç›®æ¨™æ•¸å€¼çš„è§’åº¦
    const targetPercent = value / maxVal;
    const targetAngle = -90 + (targetPercent * 180);

    const needleGroup = document.createElementNS(svgNS, "g");
    // è¨­å®šæ—‹è½‰ä¸­å¿ƒç‚º (100, 130)
    needleGroup.setAttribute("transform", `rotate(${targetAngle}, 100, 130)`);

    // ç•«æŒ‡é‡æœ¬é«” (ç´…è‰²ç®­é ­)
    const needle = document.createElementNS(svgNS, "path");
    // ç•«ä¸€å€‹å°–å°–çš„ä¸‰è§’å½¢
    needle.setAttribute("d", "M 96 130 L 100 45 L 104 130 Z");
    needle.setAttribute("fill", "#FF4757");
    needleGroup.appendChild(needle);

    // ç•«æŒ‡é‡ä¸­å¿ƒçš„åœ“é» (è£é£¾)
    const centerDot = document.createElementNS(svgNS, "circle");
    centerDot.setAttribute("cx", 100);
    centerDot.setAttribute("cy", 130);
    centerDot.setAttribute("r", 5);
    centerDot.setAttribute("fill", "#2F3542");
    needleGroup.appendChild(centerDot);

    svg.appendChild(needleGroup);

    // 4. é¡¯ç¤ºå–®ä½æ¨™ç±¤
    const unitText = document.createElementNS(svgNS, "text");
    unitText.setAttribute("x", 100);
    unitText.setAttribute("y", 100); // ç¨å¾®ä¸Šé¢ä¸€é»
    unitText.setAttribute("text-anchor", "middle");
    unitText.setAttribute("fill", "#89CFF0");
    unitText.setAttribute("font-size", "20");
    unitText.setAttribute("font-weight", "bold");
    unitText.textContent = "g";
    svg.appendChild(unitText);

    return svg;
}
